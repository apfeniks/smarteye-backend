<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
    http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

    <!-- Справочники -->
    <changeSet id="002-01-products" author="smarteye">
        <createTable tableName="products">
            <column name="id"              type="bigserial">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="code"            type="varchar(64)"/>
            <column name="gost_name"       type="varchar(256)"/>
            <column name="commercial_name" type="varchar(256)"/>
            <column name="active"          type="boolean" defaultValueBoolean="true"/>
            <column name="created_at"      type="timestamptz" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="products" indexName="idx_products_code">
            <column name="code"/>
        </createIndex>
    </changeSet>

    <changeSet id="002-02-colors" author="smarteye">
        <createTable tableName="colors">
            <column name="id"         type="bigserial">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="group_name" type="varchar(64)"/>
            <column name="name"       type="varchar(128)"/>
            <column name="created_at" type="timestamptz" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="002-03-surface-types" author="smarteye">
        <createTable tableName="surface_types">
            <column name="id"         type="bigserial">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name"       type="varchar(128)"/>
            <column name="created_at" type="timestamptz" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="002-04-recipes" author="smarteye">
        <createTable tableName="recipes">
            <column name="id"         type="bigserial">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="type"       type="varchar(16)" remarks="BASE/FACE"/>
            <column name="name"       type="varchar(128)"/>
            <column name="params"     type="jsonb"/>
            <column name="active"     type="boolean" defaultValueBoolean="true"/>
            <column name="created_at" type="timestamptz" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        <createIndex tableName="recipes" indexName="idx_recipes_type">
            <column name="type"/>
        </createIndex>
    </changeSet>

    <!-- Операционные события -->
    <changeSet id="002-05-weights" author="smarteye">
        <createTable tableName="weights">
            <column name="id"             type="bigserial">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="station"        type="varchar(32)" remarks="WS1/WS2"/>
            <column name="tech_pallet_id" type="bigint">
                <constraints nullable="true" referencedTableName="tech_pallets" referencedColumnNames="id" foreignKeyName="fk_weights_pallet"/>
            </column>
            <column name="gross_kg"       type="numeric(10,3)"/>
            <column name="tare_kg"        type="numeric(10,3)"/>
            <column name="net_kg"         type="numeric(10,3)"/>
            <column name="captured_at"    type="timestamptz" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="meta"           type="jsonb"/>
        </createTable>
        <createIndex tableName="weights" indexName="idx_weights_station">
            <column name="station"/>
        </createIndex>
    </changeSet>

    <changeSet id="002-06-rfid-events" author="smarteye">
        <createTable tableName="rfid_events">
            <column name="id"          type="bigserial">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="rfid_tag"    type="varchar(64)"/>
            <column name="reader_id"   type="varchar(64)"/>
            <column name="location"    type="varchar(128)"/>
            <column name="event_time"  type="timestamptz" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="meta"        type="jsonb"/>
        </createTable>
        <createIndex tableName="rfid_events" indexName="idx_rfid_events_tag">
            <column name="rfid_tag"/>
        </createIndex>
    </changeSet>

    <!-- Аудит и базовые ACL "на потом" -->
    <changeSet id="002-07-audit" author="smarteye">
        <createTable tableName="audit_log">
            <column name="id"         type="bigserial">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ts"         type="timestamptz" defaultValueComputed="CURRENT_TIMESTAMP"/>
            <column name="actor"      type="varchar(128)"/>
            <column name="action"     type="varchar(64)"/>
            <column name="entity"     type="varchar(64)"/>
            <column name="entity_id"  type="bigint"/>
            <column name="details"    type="jsonb"/>
        </createTable>
    </changeSet>

</databaseChangeLog>
